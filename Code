// accessing lab machine. 
ssh pjacome@144.24.46.199

//Make Directory Coughvid_raw
hdfs dfs -mkdir -p coughvid_raw
hdfs dfs -ls


//upload file
wget https://github.com/PJacome213/TermProjectCIS4560_32564/raw/refs/heads/main/COUGHVID_V3_CSVs.zip

//unzip file 
unzip COUGHVID_V3_CSVs.zip

// put files on dir

hdfs dfs -put COUGHVID_V3_CSVs/coughvid_v3.csv coughvid_raw/
hdfs dfs -put COUGHVID_V3_CSVs/extracted_features_coughvid_v3.csv coughvid_raw/  
hdfs dfs -put COUGHVID_V3_CSVs/filtered_expert_labels_coughvid_v3.csv coughvid_raw/
hdfs dfs -put COUGHVID_V3_CSVs/metadata_compiled.csv coughvid_raw coughvid_raw/

//start Beeline
beeline

//use my database 
use pjacome;

//create table cough_metadata from coughvid_3.csv
DROP TABLE IF EXISTS cough_metadata;

CREATE EXTERNAL TABLE cough_metadata (
    uuid STRING,
    age STRING,
    gender STRING,
    location STRING,
    status STRING,
    cough_type STRING,
    cough_detected DOUBLE,
    confidence DOUBLE,
    respiratory_condition STRING,
    difficulty_breathing STRING,
    fever_muscle_pain STRING,
    sore_throat STRING
)
ROW FORMAT DELIMITED
FIELDS TERMINATED BY ','
STORED AS TEXTFILE
LOCATION '/user/pjacome/coughvid_raw'
TBLPROPERTIES ('skip.header.line.count'='1');

//create table extracted_features from extracted_features_coughvid_v3.csv
DROP TABLE IF EXISTS extracted_features;

CREATE EXTERNAL TABLE extracted_features (
    uuid STRING,
    zcr DOUBLE,
    rms DOUBLE,
    mfcc_0 DOUBLE,
    mfcc_1 DOUBLE,
    mfcc_2 DOUBLE,
    mfcc_3 DOUBLE,
    mfcc_4 DOUBLE,
    mfcc_5 DOUBLE,
    mfcc_6 DOUBLE,
    mfcc_7 DOUBLE,
    mfcc_8 DOUBLE,
    mfcc_9 DOUBLE,
    mfcc_10 DOUBLE,
    mfcc_11 DOUBLE,
    mfcc_12 DOUBLE
)
ROW FORMAT DELIMITED
FIELDS TERMINATED BY ','
STORED AS TEXTFILE
LOCATION '/user/pjacome/coughvid_raw'
TBLPROPERTIES ('skip.header.line.count'='1');

//create table expert_labels from filtered_expert_labels_coughvid_v3.csv
DROP TABLE IF EXISTS expert_labels;

CREATE EXTERNAL TABLE expert_labels (
    uuid STRING,
    label STRING
)
ROW FORMAT DELIMITED
FIELDS TERMINATED BY ','
STORED AS TEXTFILE
LOCATION '/user/pjacome/coughvid_raw'
TBLPROPERTIES ('skip.header.line.count'='1');

//Clean and + Join all data into 1 table. It has no location because it is not an external table. 
DROP TABLE IF EXISTS cough_enriched;

CREATE TABLE cough_enriched AS
SELECT
    m.uuid,
    CAST(m.age AS INT) AS age,
    UPPER(m.gender) AS gender,
    INITCAP(m.location) AS location,
    UPPER(m.status) AS status,
    m.cough_type,
    ROUND(m.cough_detected, 2) AS cough_detected,
    ROUND(m.confidence, 2) AS confidence,
    m.respiratory_condition,
    m.difficulty_breathing,
    m.fever_muscle_pain,
    m.sore_throat,
    f.zcr,
    f.rms,
    f.mfcc_0, f.mfcc_1, f.mfcc_2, f.mfcc_3, f.mfcc_4,
    f.mfcc_5, f.mfcc_6, f.mfcc_7, f.mfcc_8, f.mfcc_9,
    f.mfcc_10, f.mfcc_11, f.mfcc_12,
    e.label AS expert_label
FROM cough_metadata m
LEFT JOIN extracted_features f ON m.uuid = f.uuid
LEFT JOIN expert_labels e ON m.uuid = e.uuid
WHERE m.cough_detected IS NOT NULL AND m.confidence > 0.6;

//Export to CSV 
INSERT OVERWRITE DIRECTORY '/user/pjacome/coughvid_output'
ROW FORMAT DELIMITED
FIELDS TERMINATED BY ','
SELECT * FROM cough_enriched;

//download data to hdfs. 
hdfs dfs -ls /user/pjacome/coughvid_output
hdfs dfs -get /user/pjacome/coughvid_output/000000_0 coughvid_final.csv


//download to my desktop 
scp pjacome@144.24.46.199:/home/pjacome/coughvid_final.csv .
